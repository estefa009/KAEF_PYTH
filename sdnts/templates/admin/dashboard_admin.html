{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="icon" type="image/ico" href="{% static 'icon/2.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link rel="stylesheet" href="{% static 'css/menu.css' %}">
  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {% include "includes/nav_admin.html" %} <br><br>

   <div class="container-fluid">
    <div class="dashboard-cards">
        <!-- Tarjeta Usuarios -->
        <div class="dashboard-card">
            <div class="card-title">Usuarios registrados</div>
            <div class="card-value">{{ total_usuarios }}</div>
            <div class="card-desc">Total de usuarios en la plataforma</div>
        </div>
        
        <!-- Tarjeta Clientes -->
        <div class="dashboard-card">
            <div class="card-title">Clientes</div>
            <div class="card-value">{{ total_clientes }}</div>
            <div class="card-desc">Usuarios con rol Cliente</div>
        </div>
        
        <!-- Tarjeta Domiciliarios -->
        <div class="dashboard-card">
            <div class="card-title">Domiciliarios</div>
            <div class="card-value">{{ total_domis }}</div>
            <div class="card-desc">Usuarios con rol Domiciliario</div>
        </div>
        
        <!-- Tarjeta Ventas -->
        <div class="dashboard-card">
            <div class="card-title">Ventas totales</div>
            <div class="card-value">{{ total_ventas }}</div>
            <div class="card-desc">Cantidad total de ventas</div>
        </div>
        
        <!-- Tarjeta Monto Ventas -->
        <div class="dashboard-card">
            <div class="card-title">Monto total</div>
            <div class="card-value">${{ total_ventas_monto|floatformat:2 }}</div>
            <div class="card-desc">Valor total de ventas</div>
        </div>
    </div>

</div>

        <!-- NUEVA SECCIÓN DE REPORTES -->
        <div class="dashboard-reports-section">
            <h2>Reportes y Exportaciones</h2>
            <div class="dashboard-reports-grid">
                <div class="dashboard-report-card">
                    <div class="card-title">Insumos</div>
                    <a href="{% url 'reporte_insumo' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Producción</div>
                    <a href="{% url 'reporte_produccion' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Ventas</div>
                    <a href="{% url 'reporte_ventas' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Entradas</div>
                    <a href="{% url 'reporte_entradas' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Salidas</div>
                    <a href="{% url 'reporte_salidas' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Proveedores</div>
                    <a href="{% url 'reporte_proveedores' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Categorías</div>
                    <a href="{% url 'reporte_categorias' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Envíos</div>
                    <a href="{% url 'reporte_envios' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
                <div class="dashboard-report-card">
                    <div class="card-title">Usuarios</div>
                    <a href="{% url 'usuarios_pdf' %}" class="btn btn-danger btn-sm mb-1">PDF</a>
                </div>
            </div>
        </div>

        <!-- NUEVA SECCIÓN DE GRÁFICAS -->
        <div class="dashboard-charts-section">
            <h2>Gráficas de Ventas</h2>
            <div class="dashboard-charts-grid" style="display: flex; gap: 30px; flex-wrap: wrap;">
                <div class="dashboard-chart-card" style="flex: 2 1 480px; min-width: 350px; max-width: 700px;">
                    <canvas id="ventasMensualesChart" style="width:100%; height:340px; min-height:320px; max-height:370px;"></canvas>
                </div>
                <div class="dashboard-chart-card" style="flex: 1 1 320px; min-width: 260px; max-width: 420px;">
                    <canvas id="ventasPorProductoChart" style="width:100%; height:320px; min-height:260px; max-height:340px;"></canvas>
                </div>
                <div class="dashboard-chart-card" style="flex: 1 1 320px; min-width: 260px; max-width: 420px;">
                    <canvas id="clientesTopChart" style="width:100%; height:320px; min-height:260px; max-height:340px;"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-table-card">
            <h2>Gestión de Usuarios</h2>
            <div class="d-flex justify-content-between mb-3">
                <div>
                    <a href="{% url 'agregar_usuario' %}" class="btn btn-rosa me-2 mb-2">
                        <i class="bi bi-person-plus"></i> Agregar Usuario
                    </a>
                </div>
               
            </div>
            <form method="GET" class="mb-3 d-flex align-items-center">
                <label for="rol" class="me-2">Filtrar por rol:</label>
                <select name="rol" id="rol" class="form-select me-2" style="width: auto;">
                    <option value="">Todos</option>
                    <option value="ADMIN" {% if rol_actual == "ADMIN" %}selected{% endif %}>Administrador</option>
                    <option value="CLIENTE" {% if rol_actual == "CLIENTE" %}selected{% endif %}>Cliente</option>
                    <option value="DOMI" {% if rol_actual == "DOMI" %}selected{% endif %}>Domiciliario</option>
                </select>
                <button type="submit" class="btn btn-primary">Aplicar</button>
            </form>
            <div class="table-responsive">
                <table class="table tabla-usuarios">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if usuarios %}
                            {% for usuario in usuarios %}
                                <tr>
                                    <td>{{ usuario.cod_usuario }}</td>
                                    <td>{{ usuario.nom_usua }}</td>
                                    <td>{{ usuario.apell_usua }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td>
                                        <span class="status-badge 
                                            {% if usuario.rol == 'ADMIN' %}status-in-progress
                                            {% elif usuario.rol == 'CLIENTE' %}status-completed
                                            {% elif usuario.rol == 'DOMI' %}status-pending
                                            {% endif %}">
                                            {{ usuario.get_rol_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'editar_usuario' cod_usuario=usuario.cod_usuario %}" class="btn btn-rosa me-2">
                                            <i class="bi bi-pencil"></i> Editar
                                        </a>
                                        <a href="{% url 'eliminar_usuario' cod_usuario=usuario.cod_usuario %}"
                                           onclick="return confirm('¿Estás seguro de que deseas eliminar este usuario?');"
                                           class="btn btn-danger">
                                            Eliminar
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="no-data py-3">No hay usuarios disponibles.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gráfica de ventas mensuales
        const ventasMensualesData = {{ ventas_mensuales|safe }};
        const ventasMensualesLabels = ventasMensualesData.labels || [];
        const ventasMensualesValores = ventasMensualesData.data || [];
        const ctx1 = document.getElementById('ventasMensualesChart');
        if (ctx1) {
            new Chart(ctx1.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ventasMensualesLabels,
                    datasets: [{
                        label: 'Monto de ventas ($)',
                        data: ventasMensualesValores,
                        backgroundColor: '#f357a8',
                        borderRadius: 8,
                        borderWidth: 2,
                        borderColor: '#7b2ff2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Ventas por Mes', color: '#7b2ff2', font: { size: 18 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Mes', color: '#7b2ff2' },
                            ticks: { color: '#7b2ff2' }
                        },
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Monto ($)', color: '#7b2ff2' },
                            ticks: { color: '#7b2ff2', callback: value => '$' + value }
                        }
                    }
                }
            });
        }

        // Gráfica de ventas por producto
        const ventasPorProductoData = {{ ventas_por_producto|safe }};
        const ventasPorProductoLabels = ventasPorProductoData.labels || [];
        const ventasPorProductoValores = ventasPorProductoData.data || [];
        const ctx2 = document.getElementById('ventasPorProductoChart');
        if (ctx2) {
            new Chart(ctx2.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ventasPorProductoLabels,
                    datasets: [{
                        label: 'Cantidad vendida',
                        data: ventasPorProductoValores,
                        backgroundColor: [
                            '#7b2ff2', '#f357a8', '#ffb347', '#4e4032', '#fc6998', '#ffc0cb', '#a3e635', '#fbbf24', '#f87171'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#7b2ff2', font: { size: 14 } } },
                        title: { display: true, text: 'Ventas por Producto', color: '#7b2ff2', font: { size: 18 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + ' unidades';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfica de clientes con más compras
        const clientesTopData = {{ clientes_top|safe }};
        const clientesTopLabels = clientesTopData.labels || [];
        const clientesTopValores = clientesTopData.data || [];
        const ctx3 = document.getElementById('clientesTopChart');
        if (ctx3) {
            new Chart(ctx3.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: clientesTopLabels,
                    datasets: [{
                        label: 'Compras realizadas',
                        data: clientesTopValores,
                        backgroundColor: '#a3e635',
                        borderRadius: 8,
                        borderWidth: 2,
                        borderColor: '#7b2ff2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Clientes con más compras', color: '#7b2ff2', font: { size: 18 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' compras';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Cliente', color: '#7b2ff2' },
                            ticks: { color: '#7b2ff2', font: { size: 12 }, autoSkip: false, maxRotation: 45, minRotation: 0 }
                        },
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Compras', color: '#7b2ff2' },
                            ticks: { color: '#7b2ff2' }
                        }
                    }
                }
            });
        }
    });
    </script>
</body>
</html>