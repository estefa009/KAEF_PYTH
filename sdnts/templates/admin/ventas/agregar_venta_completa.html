<!-- agregar_venta_completa.html -->
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Agregar Venta Completa</title>
    <link rel="icon" type="image/ico" href="{% static 'icon/2.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link rel="stylesheet" href="{% static 'css/menu.css' %}">
    <link rel="stylesheet" href="{% static 'css/agregar_venta.css' %}">
</head>
<body>
{% include "includes/nav_admin.html" %}

<div class="container mt-5">
    <h2>Agregar Venta Completa</h2>
    <form method="post">
        {% csrf_token %}

        <h4>Datos de la Venta</h4>
        {{ venta_form.as_p }}

        <h4>Productos en la Venta</h4>
        {{ detalle_formset.management_form }}
        {% for form in detalle_formset %}
            <div class="border rounded p-3 mb-3 bg-light detalle-form">
                {{ form.as_p }}
            </div>
        {% endfor %}

        <h4>Combinaciones Personalizadas</h4>
        {{ combinacion_formset.management_form }}
        {% for form in combinacion_formset %}
            <div class="border rounded p-3 mb-3 bg-light combinacion-form">
                {{ form.cod_producto.label_tag }} {{ form.cod_producto }}
                {{ form.cod_sabor_masa_1.label_tag }} {{ form.cod_sabor_masa_1 }}
                {{ form.cod_glaseado_1.label_tag }} {{ form.cod_glaseado_1 }}
                {{ form.cod_topping_1.label_tag }} {{ form.cod_topping_1 }}
            </div>
        {% endfor %}

        <h4>Totales</h4>
        <p>Subtotal: $<span id="subtotal">0.00</span></p>
        <p>IVA (19%): $<span id="iva">0.00</span></p>
        <p>Total: $<span id="total">0.00</span></p>

        <h4>Pago</h4>
        {{ pago_form.as_p }}

        <button type="submit" class="btn btn-success">Guardar Venta</button>
        <a href="{% url 'ventas_admin' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<script>
    const precios = {{ precios_productos|safe }};

    document.addEventListener('DOMContentLoaded', function () {
        function actualizarTotales() {
            let subtotal = 0;

            document.querySelectorAll('.detalle-form').forEach((form, index) => {
                const productoSelect = form.querySelector('select[name$="cod_producto"]');
                const cantidadInput = form.querySelector('input[name$="cantidad"]');
                const precioInput = form.querySelector('input[name$="precio_unitario"]');

                if (productoSelect && cantidadInput && precioInput) {
                    const cantidad = parseFloat(cantidadInput.value) || 0;
                    const precio = parseFloat(precioInput.value) || 0;
                    subtotal += cantidad * precio;
                }
            });

            const iva = subtotal * 0.19;
            const total = subtotal + iva;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('iva').textContent = iva.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);

            // Actualizar campo de monto_total si existe
            const montoTotalInput = document.querySelector('input[name$="monto_total"]');
            if (montoTotalInput) {
                montoTotalInput.value = total.toFixed(2);
            }
        }

        // Asociar eventos a cada formulario de detalle
        document.querySelectorAll('.detalle-form').forEach((form, index) => {
            const productoSelect = form.querySelector('select[name$="cod_producto"]');
            const cantidadInput = form.querySelector('input[name$="cantidad"]');
            const precioInput = form.querySelector('input[name$="precio_unitario"]');

            if (productoSelect && precioInput) {
                productoSelect.addEventListener('change', function () {
                    const productoId = this.value;
                    if (precios[productoId]) {
                        precioInput.value = precios[productoId];
                        actualizarTotales();
                    }
                });
            }

            if (cantidadInput) {
                cantidadInput.addEventListener('input', actualizarTotales);
            }

            if (precioInput) {
                precioInput.addEventListener('input', actualizarTotales);
            }
        });

        // Calcular al cargar por si hay datos precargados
        actualizarTotales();
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Calcular fecha mínima: hoy + 3 días
    const hoy = new Date();
    hoy.setDate(hoy.getDate() + 3);
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');
    const hh = String(hoy.getHours()).padStart(2, '0');
    const min = String(hoy.getMinutes()).padStart(2, '0');

    // Formato para input type="datetime-local"
    const fechaMinima = `${yyyy}-${mm}-${dd}T${hh}:${min}`;

    // Aplicar a todos los campos de tipo datetime-local
    document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
        input.min = fechaMinima;
    });

    // También aplica a campos de tipo date si los tienes
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.min = `${yyyy}-${mm}-${dd}`;
    });
});
</script>


</body>
</html>
